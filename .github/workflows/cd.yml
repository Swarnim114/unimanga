name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: [self-hosted]
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Apply ConfigMap
        run: kubectl apply -f k8s/configmap.yaml

      - name: Create Secret from GitHub Secrets
        run: |
          kubectl create secret generic unimanga-backend-secret \
            --from-literal=MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Deployment
        run: kubectl apply -f k8s/deployment.yaml

      - name: Apply Service
        run: kubectl apply -f k8s/service.yaml
     
      - name: Restart pod
        run: kubectl rollout restart deployment/unimanga-backend 

      - name: Wait for rollout
        run: kubectl rollout status deployment/unimanga-backend --timeout=5m

      - name: Get deployment info
        run: |
          echo "=== Pods ==="
          kubectl get pods -l app=unimanga-backend
          echo ""
          echo "=== Service ==="
          kubectl get svc unimanga-backend
          echo ""
          echo "=== Deployment ==="
          kubectl get deployment unimanga-backend

      - name: Wait for pods ready
        run: kubectl wait --for=condition=ready pod -l app=unimanga-backend --timeout=300s

      - name: Test API via NodePort
        run: |
          echo "Testing API on NodePort 30001..."
          
          for i in {1..10}; do
            if curl -f -s http://localhost:30001/; then
              echo "✅ Health check passed"
              break
            fi
            echo "Attempt $i/10 failed, retrying in 5s..."
            sleep 5
          done
          
          echo "Testing auth endpoint..."
          curl -s http://localhost:30001/api/auth/login && echo "✅ Auth endpoint accessible"
          
          echo "Testing protected endpoint..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:30001/api/library)
          echo "Protected endpoint returned: $STATUS (expected 401)"
          
          echo "✅ Deployment successful! API available at http://<EC2-IP>:30001/"

      - name: Show logs on failure
        if: failure()
        run: kubectl logs -l app=unimanga-backend --tail=100

